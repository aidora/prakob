<!doctype html>
<html>
<head>
  <title>Aiyara Cluster :: Prakob</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"></link>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="angular.js"></script>
  <script src="monitor.js"></script>
  <script type="text/javascript">

    String.prototype.endsWith = function(suffix) {
      return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };

    var url = "http://192.168.1.3:8888/";

    function pause(containerName, isPaused){
      var cmd = isPaused ? "unpause" : "pause";
      $.post(url + "containers" + containerName + "/" + cmd, function(){
        updateContainers();
      });
    }

    function kill(containerName, isPaused){
      if(isPaused) {
        pause(containerName, true);
      }
      $.post(url + "containers" + containerName + "/kill", function(){
        updateContainers();
      });
    }

    var nodeMap = {};

    function updateContainers(){
      /*
      $.getJSON(url + "containers/json", function(data){
        $("#matrix").find("tr:gt(0)").remove();

        $.each(data, function(k,v){
          var row = "<tr>";

          row += "<td>" + k + "</td>";
          var name = v.Names[0];
          row += "<td>" + name + "</td>";
          row += "<td>" + v.Image + "</td>";
          row += "<td>" + v.Command + "</td>";
          var ports = "";
          $.each(v.Ports, function(kp,vp){
            ports += vp.IP + ":" + vp.PublicPort + "->" + vp.PrivatePort + "/" + vp.Type + "<br/>";
          });
          row += "<td>" + ports + "</td>";
          row += "<td>" + v.Status + "</td>";

          var paused = v.Status.endsWith("(Paused)");
          var glyph = paused ? "play" : "pause";
          row += "<td><span class='glyphicon glyphicon-" + glyph + "' onclick='javascript:pause(\"" + name + "\", " + paused + ")'></span></td>";
          row += "<td><span class='glyphicon glyphicon-remove' onclick='javascript:kill(\"" + name + "\", " + paused + ")'></span></td>";

          $("#matrix").append(row + "</tr>");

        });
      });
      */
    }

  setTimeout(updateContainers, 500);
  setInterval(updateContainers, 1500);

  </script>

</head>

<body ng-app="monitor" ng-controller="MonitorCtrl">
  <div class="panel panel-default" style="width: 99%; margin-top: 10px; margin-left: 10px; auto">

    <div style="display: table;">
      <img style="display: table-cell; vertical-align: middle;" src="prakob/media/sut.png"></img>
      <h2 style="display: table-cell; vertical-align: middle;">Aiyara Cluster :: Prakob (ประกอบ)</h2>
    </div>

    <style type="text/css">
      .panel {
        border: 0;
      }
    </style>

    <div class="panel-heading">
      <a href="prakob" class="btn btn-success">New cluster</a>
      <button class="btn btn-success" ng-click="updateContainers()">Test</button>
    </div>

    <table id="matrix" class="table table-bordered table-hover">
      <thead>
        <tr>
          <!--th>#</th-->
          <th>Name</th>
          <th>Image</th>
          <th>Command</th>
          <th>Ports</th>
          <th>Status</th>
          <th style="width: 3em">pause</th>
          <th style="width: 3em">kill</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="c in containers">
          <td>{{c.Names[0]}}</td>
          <td>{{c.Image}}</td>
          <td>{{c.Command}}</td>
          <td>
            <div ng-repeat="p in c.Ports">
              {{p.IP}}:{{p.PublicPort}}->{{p.PrivatePort}}/{{p.Type}}<br/>
            </div>
          </td>
          <td>{{c.Status}}</td>
          <td>
            <span ng-click="pause(c.Id, c.Status)"
                  ng-class="(c.Status.endsWith('(Paused)')) ? 'glyphicon-play':'glyphicon-pause'"
                  class="glyphicon">
            </span>
          </td>
          <td>
            <span ng-click="kill(c.Id)"
                  ng-class="(c.Status.endsWith('(Paused)')) ? 'glyphicon-remove':'glyphicon-ban-circle'"
                  class="glyphicon">
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="logs"></div>
</body>
</html>